---
title: "Processing"
output: html_notebook
---
Neste notebook faremos a limpeza dos dados, ajustando colunas e filtrando amostras com cobertura de sequenciamento baixa, e também slecionaremos o core microbiome, baseado em prevalência e abundância.

```{r setup}
#setar diretório de trabalho para a pasta do projeto
knitr::opts_knit$set(root.dir = '/home/gustavo/Projeto')
```

## Importação de dados, pacotes e funções personalizadas
```{r}
#importação de bibliotecas
library(microbiome)
library(MicrobiotaProcess)
library(phyloseq)
library(tidyverse)
library(Biostrings)
library(ggplot2)
#importar funções utilizadas
source(file = "source/clean_bacteria.R", local = TRUE)
source(file = "source/clean_fungi.R", local = TRUE)
source(file = "source/core_bacteria.R", local = TRUE)
#importar dados brutos (já transformados em phyloseq antes)
load("data/raw/phyloseqbacteria.rds")
load("data/raw/phyloseqfungo.rds")
```
## Limpeza dos dados metagenômicos
 
Aplicamos a função clean para realizar as operações de limpeza, para mais detalhes, olhar o script da função na pasta "source" do projeto
```{r}
#limpar phyloseq
bac_split <- clean_pseq(bacteria)
fun_split <- clean_pseq(fungi)
#Filtrar só os locais de interesse
bac_split = bac_split[c("Floor","Scalp", "Wall")]
fun_split = fun_split[c("Floor","Scalp", "Wall")]

```
Alguns parâmetros dos dados:

Bactéria:
```{r}
source(file = "source/describe_phyloseq.R", local = TRUE)
# Aplica a função para cada objeto na lista e imprime as informações
nomes <- names(bac_split)  # Obtém os nomes dos objetos na lista
for (i in seq_along(bac_split)) {
  describe_phyloseq(bac_split[[i]], nomes[i])
}

```
Fungos:
```{r}
source(file = "source/describe_phyloseq.R", local = TRUE)
# Aplica a função para cada objeto na lista e imprime as informações
nomes <- names(fun_split)  # Obtém os nomes dos objetos na lista
for (i in seq_along(fun_split)) {
  describe_phyloseq(fun_split[[i]], nomes[i])
}

```

## Seleção do core microbiome


Aqui selecionamos o core microbiome. O corte de abundância foi baixo, deixando taxa que representam no mónimo 0,5% do total da amostra. Para prevalência, foi selecionado 30% para que ajude na hora de fazer as redes, permitindo uma correlação mais eficiente. A idéia é deixar taxa menos abundantes pois mesmo que o taxon esteja em baixa quantidade, ele pode ter uma função ecológica importante (ver artigo Microbiome dark matter).
```{r}
source(file = "source/equal_sample_number.R", local = TRUE)
floor = equal_sample_number(bac_split$Floor, fun_split$Floor)
wall = equal_sample_number(bac_split$Wall, fun_split$Wall)
scalp = equal_sample_number(bac_split$Scalp, fun_split$Scalp)
```


```{r}
#selecionar os core members
source(file = "source/core_bacteria.R", local = TRUE)
core_floor_bac_healthy <- core(floor$bac_healthy, corte_prev = 1/3, corte_abund = 0.0)
core_floor_bac_sd <- core(floor$bac_sd, corte_prev = 1/3, corte_abund = 0.0)

core_wall_bac_healthy <- core(wall$bac_healthy, corte_prev = 1/3, corte_abund = 0.0)
core_wall_bac_sd <- core(wall$bac_sd, corte_prev = 1/3, corte_abund = 0.0)

core_scalp_bac_healthy <- core(scalp$bac_healthy, corte_prev = 1/3, corte_abund = 0.00)
core_scalp_bac_sd <- core(scalp$bac_sd, corte_prev = 1/3, corte_abund = 0.0)

#filtrar os dados originais para manter apenas os core members no formato phyloseq
mask1 = taxa_names(floor$bac_healthy) %in% rownames(core_floor_bac_healthy)
floor$bac_healthy <- phyloseq::subset_taxa(floor$bac_healthy, mask1)

mask2 = taxa_names(floor$bac_sd) %in% rownames(core_floor_bac_sd)
floor$bac_sd <- subset_taxa(floor$bac_sd, mask2)

wall$bac_healthy <- subset_taxa(wall$bac_healthy, taxa_names(wall$bac_healthy) %in% rownames(core_wall_bac_healthy))
wall$bac_sd <- subset_taxa(wall$bac_sd, taxa_names(wall$bac_sd) %in% rownames(core_wall_bac_sd))

scalp$bac_healthy <- subset_taxa(scalp$bac_healthy, taxa_names(scalp$bac_healthy) %in% rownames(core_scalp_bac_healthy))
scalp$bac_sd <- subset_taxa(scalp$bac_sd, taxa_names(scalp$bac_sd) %in% rownames(core_scalp_bac_sd))
```



```{r}
#selecionar os core members
core_floor_fun_healthy <- core(floor$fun_healthy, corte_prev = 1/3, corte_abund = 0.0)
core_floor_fun_sd <- core(floor$fun_sd, corte_prev = 1/3, corte_abund = 0.0)

core_wall_fun_healthy <- core(wall$fun_healthy, corte_prev = 1/3, corte_abund = 0.0)
core_wall_fun_sd <- core(wall$fun_sd, corte_prev = 1/3, corte_abund = 0.0)

core_scalp_fun_healthy <- core(scalp$fun_healthy, corte_prev = 1/3, corte_abund = 0.00)
core_scalp_fun_sd <- core(scalp$fun_sd, corte_prev = 1/3, corte_abund = 0.0)

#filtrar os dados originais para manter apenas os core members no formato phyloseq
mask1 = taxa_names(floor$fun_healthy) %in% rownames(core_floor_fun_healthy)
floor$fun_healthy <- phyloseq::subset_taxa(floor$fun_healthy, mask1)

mask2 = taxa_names(floor$fun_sd) %in% rownames(core_floor_fun_sd)
floor$fun_sd <- subset_taxa(floor$fun_sd, mask2)

wall$fun_healthy <- subset_taxa(wall$fun_healthy, taxa_names(wall$fun_healthy) %in% rownames(core_wall_fun_healthy))
wall$bac_sd <- subset_taxa(wall$bac_sd, taxa_names(wall$bac_sd) %in% rownames(core_wall_bac_sd))

scalp$fun_healthy <- subset_taxa(scalp$fun_healthy, taxa_names(scalp$fun_healthy) %in% rownames(core_scalp_fun_healthy))
scalp$fun_sd <- subset_taxa(scalp$fun_sd, taxa_names(scalp$fun_sd) %in% rownames(core_scalp_fun_sd))
```

### Gerar tabela com comparativo de métricas para os metadados 

```{r}
#criar lista de objetos para exportação e exportar
pseq_core <- list(floor= floor,
                  wall = wall,
                  scalp = scalp )

```

## Exportação dos dados
```{r}
#salvar como objeto R na pasta de dados
save(pseq_core, file =  "data/processed/pseq_core14102024.rds")
```

